name: hw1
on: [push, pull_request]

jobs:
  Setup:
    runs-on: Ubuntu-20.04
    
    steps:
      - name: Checkout repository code
        uses: actions/checkout@v2
        
      - name: Setting up a vm
        run: |
          sudo apt install git
          sudo apt install libgtest-dev
          sudo apt install build-essential
          sudo apt install valgrind
          sudo apt install clang-tidy
          sudo apt install lcov


      - name: Build
        run: |
          cd hw1
          mkdir build
          cd build
          cmake .. -DCMAKE_EXPORT_COMPILE_COMANDS=1
          make
          
      - name: Clang
        run: |
          cd hw1
          run-clang-tidy > build/report-clang.txt
          

      - name: Unit-tests
        run: |
          cd hw1/build
          ./correct_test
          ./mem_test
    

      - name: Valgrind
        run: |
          cd hw1/build
          valgrind --log-file=report-valgrind1.txt -- ./mem_test
          valgrind --log-file=report-valgrind2.txt -- ./correct_test
          

      - name: Coverage
        run: |
          cd hw1/build
          lcov -t "hw1" -o hw1.info -c -d .
          lcov --extract hw1.info "*/hw1/*" -o hw1.info
          genhtml -o report-lcov.html hw1.info          
